CREATE SCHEMA IF NOT EXISTS `etrendo-prd.amazon_silver`;

CREATE OR REPLACE TABLE `etrendo-prd.amazon_silver.amazon_coffee_machines_snapshot_daily_base`
PARTITION BY snapshot_date
CLUSTER BY asin AS
SELECT
  DATE(extracted_at) AS snapshot_date,
  extracted_at,

  asin,
  node,
  category_label,
  title,
  brand,
  url,

  currency,

  -- PDP truth (clean)
  price_clean            AS pdp_price,
  price_shipping_clean   AS pdp_price_shipping,
  total_price_clean      AS pdp_total_price,

  -- Buy Box fields (already parsed)
  buybox_seller_id,
  buybox_seller_name,
  buybox_price_from_json_clean AS buybox_price_from_json,
  buybox_is_amazon,
  buybox_stock,

  -- Availability / debug
  stock,
  item_status,
  status_code,
  error_message,

  -- Key quality label
  pdp_extraction_state,

  -- Simple business-facing state
  CASE
    WHEN pdp_extraction_state = 'COMPLETE' THEN 'BUYABLE'
    WHEN pdp_extraction_state = 'INCOMPLETE_PRICE_EXTRACTION' THEN 'INCOMPLETE'
    ELSE 'UNKNOWN'
  END AS pdp_state

FROM `etrendo-prd.amazon_silver_stg.amazon_product_details_coffee_machines_flat`
QUALIFY ROW_NUMBER() OVER (
  PARTITION BY asin, DATE(extracted_at)
  ORDER BY extracted_at DESC
) = 1;
CREATE SCHEMA IF NOT EXISTS `etrendo-prd.amazon_silver`;

CREATE OR REPLACE TABLE `etrendo-prd.amazon_silver.amazon_coffee_machines_snapshot_daily`
PARTITION BY snapshot_date
CLUSTER BY asin AS

WITH pdp_daily AS (
  -- 1 row per ASIN per day (latest extraction)
  SELECT
    DATE(extracted_at) AS snapshot_date,
    extracted_at,

    asin,
    node,
    category_label,
    title,
    brand,
    url,
    currency,

    -- PDP truth (clean)
    price_clean          AS pdp_price,
    price_shipping_clean AS pdp_price_shipping,
    total_price_clean    AS pdp_total_price,

    -- Buy Box
    buybox_seller_id,
    buybox_seller_name,
    buybox_price_from_json_clean AS buybox_price_from_json,
    buybox_is_amazon,
    buybox_stock,

    -- Debug / quality
    stock,
    item_status,
    status_code,
    error_message,
    pdp_extraction_state,

    CASE
      WHEN pdp_extraction_state = 'COMPLETE' THEN 'BUYABLE'
      WHEN pdp_extraction_state = 'INCOMPLETE_PRICE_EXTRACTION' THEN 'INCOMPLETE'
      ELSE 'UNKNOWN'
    END AS pdp_state

  FROM `etrendo-prd.amazon_silver_stg.amazon_product_details_coffee_machines_flat`
  WHERE asin IS NOT NULL
    AND TRIM(asin) != ''
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY asin, DATE(extracted_at)
    ORDER BY extracted_at DESC
  ) = 1
),

listing_latest AS (
  -- latest listing per ASIN
  SELECT * EXCEPT(rn)
  FROM (
    SELECT
      *,
      ROW_NUMBER() OVER (PARTITION BY asin ORDER BY extracted_at DESC) AS rn
    FROM `etrendo-prd.amazon_silver.amazon_product_listing_coffee_machines_current`
    WHERE asin IS NOT NULL
      AND TRIM(asin) != ''
  )
  WHERE rn = 1
),

offers_daily AS (
  -- daily offer summary
  SELECT
    DATE(extracted_at) AS offer_date,
    asin,

    COUNT(*) AS offer_rows,
    COUNT(DISTINCT NULLIF(TRIM(seller_id), '')) AS seller_id_count,

    MIN(
      SAFE_CAST(price AS NUMERIC)
      + COALESCE(SAFE_CAST(price_shipping AS NUMERIC), 0)
    ) AS min_total_price,

    APPROX_QUANTILES(
      SAFE_CAST(price AS NUMERIC)
      + COALESCE(SAFE_CAST(price_shipping AS NUMERIC), 0),
      2
    )[OFFSET(1)] AS median_total_price,

    MAX(
      SAFE_CAST(price AS NUMERIC)
      + COALESCE(SAFE_CAST(price_shipping AS NUMERIC), 0)
    ) AS max_total_price

  FROM `etrendo-prd.amazon_silver_stg.amazon_price_listing_coffee_machines_flat`
  WHERE asin IS NOT NULL
    AND TRIM(asin) != ''
    AND SAFE_CAST(price AS NUMERIC) > 0
  GROUP BY offer_date, asin
)

SELECT
  s.snapshot_date,
  s.extracted_at,
  s.asin,
  s.node,
  s.category_label,
  s.title,
  s.brand,
  s.url,
  s.currency,

  -- PDP
  s.pdp_price,
  s.pdp_price_shipping,
  s.pdp_total_price,

  s.buybox_seller_id,
  s.buybox_seller_name,
  s.buybox_is_amazon,
  s.buybox_stock,
  s.pdp_extraction_state,
  s.pdp_state,

  -- Listing context
  l.is_sponsored,
  l.position AS listing_position,
  SAFE_CAST(l.page_number AS INT64) AS listing_page,

  -- Offers
  COALESCE(o.offer_rows, 0) AS offer_rows,
  COALESCE(o.seller_id_count, 0) AS seller_id_count,
  o.min_total_price,
  o.median_total_price,
  o.max_total_price,

  -- Coverage flag
  CASE
    WHEN s.pdp_extraction_state = 'COMPLETE'
         AND COALESCE(o.offer_rows, 0) > 0
      THEN 'DETAIL_PLUS_OFFERS'
    WHEN s.pdp_extraction_state = 'COMPLETE'
      THEN 'DETAIL_ONLY'
    ELSE 'INCOMPLETE_PDP'
  END AS data_coverage

FROM pdp_daily s
LEFT JOIN listing_latest l
  ON l.asin = s.asin
LEFT JOIN offers_daily o
  ON o.asin = s.asin
 AND o.offer_date = s.snapshot_date;
